---
order: 1
icon: file-code
label: "Como implementar o Next Auth em um projeto existente?"
author:
  name: João Santos
  # avatar: ../../Imagens DocStruct/Logos/logo_struct.png
date: 2023-10-27
category: Implementação
tags:
  - Next Auth
  - instalação
  - Next.js
---

# Instalação

Para adicionar o Next Auth ao projeto basta utilizar o seguinte comando no terminal: `yarn add next-auth `, ou `pnpm add next-auth  ` se estiver utilizando o pnpm.

# Implementação

!!Atenção: verifique a versão do Next.js utilizada no projeto e se o tipo de roteamento usado é o `Pages Router` ou o `App Router`, pois o modo de implementação é diferente.

### Para versão de Next.js anterior à 13.2

Para adicionar o NextAuth.js a um projeto, crie um arquivo chamado `[...nextauth].js` na pasta `pages/api/auth/` e preencha-o com o código a baixo. Este arquivo contém o manipulador de rotas dinâmicas para o NextAuth.js, que também conterá todas as configurações globais do NextAuth.js e todas as solicitações para `/api/auth/*` (`signIn`, `callback`, `signOut`, etc.) serão automaticamente tratadas pelo NextAuth.js.

```js
import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";

export const authOptions = {
  // Configure um ou mais provedores de autenticação
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_ID,
      clientSecret: process.env.GOOGLE_SECRET,
    }),
    // ...adicione mais provedores aqui
  ],
};

export default NextAuth(authOptions);
```

### Para versão de Next.js porterior à 13.2 com o App Router

Nesse caso, crie um arquivo chamado `route.js` na pasta `app/api/auth/[...nextauth]/` e preencha-o com o código a baixo.

```js
import NextAuth from "next-auth";

const handler = NextAuth({
  // ...adicione mais provedores aqui
});

export { handler as GET, handler as POST };
```

Exemplo de route.js com GoogleProvider(Google como autenticador):

```js
import NextAuth from "next-auth/next";
import GoogleProvider from "next-auth/providers/google";

const handler = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID ,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET ,
    }),
  ],
});

export { handler as GET, handler as POST };
```

# Utilização

## Configurando useSession

O `useSession` é um importante hook do React que é utilizado nas aplicações Next Auth para recuperar informações da sessão de usuário.Para utilizá-lo primeiro é preciso expor o conteudo da sessão de usuário por meio do `<SessionProvider />`,para implementá-lo,dentro da pasta `app`, crie uma pasta `components` e, dentro desta um arquivo `provider.tsx` com o seguinte código:

```js
"use client";
import { SessionProvider } from "next-auth/react";
import React, { ReactNode } from "react";

interface Props {
  children: ReactNode;
}

const Providers = (props: Props) => {
  return <SessionProvider>{props.children}</SessionProvider>;
};

export default Providers;
```

Agora, no aqrquivo `layout.tsx`, adicione as tags de `<Providers>` por fora do elemento `{children}` como no exemplo:

```js
import Providers from "./components/provider";
import type { Metadata } from 'next'
import { Inter } from 'next/font/google'
import './globals.css'

const inter = Inter({ subsets: ['latin'] })

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  )
};
```

Dessa forma, o `useSession` terá acesso aos dados e status da sessão.

!!!warning AVISO!!

A desestruturação dos `pageProps` em session e no resto das pageProps significa uma alteração no comportamento normal de `getServerSideProps` e `getStaticProps`.

Caso pegue a session no servidor e tente passar para a página como suas pageProps, a session será interceptada aqui no App e nunca chegará no seu componente da página. Ao invés disso será usada para alimentar o hook `useSession`, portanto use-o.
Exemplo:

```js

export async function getServerSideProps(ctx) {
    const session = await getServerSession(ctx.req, ctx.res, authOptions);

    if (!session || !session.user) return { redirect: { permanent: false, destination: "/login" } }

    return {
        props: {
            session
        }
    }
}

// Dá erro, e a tipagem é mentirosa:
export default function HomePage({ session }: InferGetServerSidePropsType<typeof getServerSideProps>) {
    return <pre>{JSON.stringify(session.user)}</pre>
}
// Dá certo:
export default function HomePage() {
    const { data: session } = useSession();
    return <pre>{JSON.stringify(session.user)}</pre>
}

```

!!!

## Utilização do useSession

O Hook do React `useSession` usado no NextAuth.js é a maneira mais fácil de verificar se alguém está autenticado.Como no exemplo de botão de SignIn:

```js
"use client";
import React from "react";
import { signIn, signOut, useSession } from "next-auth/react";
const SigninButton = () => {
  const { data: session } = useSession();

  if (session && session.user) {
    return (
      <div className="flex gap-4 ml-auto">
        <p className="text-sky-600">{session.user.name}</p>
        <button onClick={() => signOut()} className="text-red-600">
          Sign Out
        </button>
      </div>
    );
  }
  return (
    <button onClick={() => signIn()} className="text-green-600 ml-auto">
      Sign In
    </button>
  );
};

export default SigninButton;
```

A ideia é armazenar os resultados do `useSession` em props para aferir se o usuário ja foi autenticado.

# Autenticação

O Next Auth possibilita que o critério de autenticação(provedores) seja por meio de credenciais (nome,senha), email ou autenticações externas(google,GitHub,etc.).

## OAuth

OAuth é o processo de autenticação do NextAuth que utiliza de processos de login externos preexistentes, ou seja, dá ao usúario a opção de realizar a autenticação por outra plataforma como Github, Google, Twitter, etc.

Por serem processos externos de várias fontes diferentes, cada autenticação escolhida terá uma documentação específica diferente. Para acessar todos os provedores de autenticação externa suportados pelo NextAuth e suas respectivas documentações clique [Aqui](https://github.com/nextauthjs/next-auth/tree/main/packages/next-auth/src/providers).

Segue um exemplo demonstrativo do Google como provedor OAuth:

```js
import GoogleProvider from "next-auth/providers/google";

GoogleProvider({
  clientId: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  profile(profile) {
    return {
      // Retorne todas as informações de perfil de que você precisa.
      // O único campo obrigatório é o 'id'
      // para ser capaz de identificar a conta quando adicionada a um banco de dados.
    };
  },
});
```

## Como conseguir as credenciais para a autenticação externa Next auth(Google)

Utilizarei o exemplo do Google como autenticador externo, pela grande gama de [documentação](https://developers.google.com/identity/protocols/oauth2?hl=pt-br) disponível.

Para configurar a autenticação com o Next Auth usando o Google como provedor, você precisará obter as credenciais apropriadas do Google. Siga estas etapas:

1. Acesse o [Console de Desenvolvedores do Google](https://console.developers.google.com/apis/credentials).

2. Com o projeto criado e/ou adicionado na plataforma, na barra de opções lateral clique no item `Credenciais` e em seguida, no botão `Criar credenciais`, escolha `ID do cliente OAuth` como tipo de credencial, e configure as informações do OAuth de acordo com as necessidades do projeto e seguindo as intruções. 

3. Preencha o campo `Tipo de aplicativo` com a opção `Aplicativo da Web`, nas seções `Origens JavaScript autorizadas` e `URLs de redirecionamento autorizados`, adicione URLs de acordo com a natureza do aplicativo, por exemplo, vale colocar `http://localhost:3000` e `http://localhost:3000/api/auth/callback/google` respectivamente, para uma aplicação que está rodando localmente. E , por fim ,clique em `Criar`.
OBS:A segunda URL depende de como foram implementadas as rotas no projeto!!

4. Após a criação do cliente OAuth, serão exibidos O `ID do cliente` e a `Chave secreta do cliente`.

5. Por fim, crie um arquivo `.env` para guardar essas informações.Como no exemplo:

```bash
# Next Auth
# You can generate a new secret on the command line with:
# openssl rand -base64 32
# https://next-auth.js.org/configuration/options#secret
NEXTAUTH_SECRET="tefsdfadagdsdfagdf123413afadf"

NEXTAUTH_URL="http://localhost:3000"

# Next Auth GOOGLE Provider
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
```

Com as credenciais armazenadas de forma segura em seu arquivo .env, você pode configurar a autenticação com o provedor do Google de maneira segura e eficaz em seu projeto Next Auth.

## Credenciais

A autenticação por Credenciais permite lidar com o login usando credenciais arbitrárias, como nome de usuário e senha, ele vem com a restrição de que os usuários autenticados dessa maneira não se mantém no banco de dados e, consequentemente, é necessário o uso de tokens(id) para implementar a validação. Por exemplo:

!!!warning
É **necessário** ter um serviço de **autenticação externo**, **ou criar** um **do zero**, para poder usar o CredentialsProvider de forma realmente útil! O NextAuth nesse caso é muito menos útil! Considere recorrer a outras bibliotecas, como [Lucia Auth](https://lucia-auth.com/).
!!!

```js

import CredentialsProvider from "next-auth/providers/credentials";
...
providers: [
  CredentialsProvider({
    // O nome exibido no formulário de login (por exemplo, 'Entrar com...')
    name: "Credentials",
    // 'credentials' é usado para gerar um formulário na página de login.
    // Você pode especificar quais campos devem ser enviados, adicionando chaves ao objeto 'credentials'
    // por exemplo, domínio, nome de usuário, senha, token de autenticação de dois fatores, etc.
    // Você pode passar qualquer atributo HTML para a tag <input> por meio do objeto.
    credentials: {
      username: { label: "Username", type: "text", placeholder: "jsmith" },
      password: { label: "Password", type: "password" }
    },
    async authorize(credentials, req) {
      // Adicione parâmetros aqui para procurar o usuário com base nas credenciais fornecidas.
      const user = { id: "1", name: "J Smith", email: "jsmith@example.com" }

      if (user) {
        // Qualquer objeto retornado será salvo na propriedade user
        return user
      } else {
        // Se você retornar null, um erro será exibido, aconselhando o usuário a verificar seus dados.
        return null

        // Você também pode rejeitar este retorno de chamada com um erro, assim o usuário será redirecionado para a página de erro com a mensagem de erro como um parâmetro de consulta
      }
    }
  })
]
...

```
